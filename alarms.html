<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Alarmes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        @keyframes pulse-red {
            0%, 100% { background-color: #fef2f2; border-color: #dc2626; }
            50% { background-color: #fee2e2; border-color: #ef4444; }
        }
        .alarm-pulse {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="main-app" class="max-w-4xl mx-auto">
        
        <!-- Header e Status da Conex√£o -->
        <header class="bg-white shadow-lg rounded-lg p-6 mb-8 border-t-4 border-indigo-600">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Monitoramento de Caldeira Industrial</h1>
            <p class="text-gray-600">Servi√ßo Alarms: Visualiza√ß√£o de eventos em tempo real.</p>
            <div id="connection-status" class="mt-4 p-2 text-sm font-medium rounded-full bg-yellow-100 text-yellow-800">
                Status: Desconectado
            </div>
        </header>

        <!-- Configura√ß√£o de Conex√£o (Hidden ap√≥s setup) 
        <div id="config-panel" class="bg-white shadow-md rounded-lg p-6 mb-8 space-y-4 border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700">Configura√ß√£o MQTT (HiveMQ)</h2>
            <input type="text" id="broker-input" placeholder="Broker (ex: xxxxx.s1.eu.hivemq.cloud)" class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            <input type="text" id="user-input" placeholder="Usu√°rio" class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            <input type="password" id="password-input" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            <button id="connect-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md">
                Conectar ao Broker
            </button>
        </div>-->

        <!-- Painel de Alarmes -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-2xl font-bold text-red-600 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                Alarmes Ativos
            </h2>
            <ul id="alarms-list" class="space-y-3">
                <li class="p-3 bg-gray-50 border border-gray-200 text-gray-500 rounded-md">
                    Aguardando alertas...
                </li>
            </ul>
        </div>
    </div>

    <script>
        const MQTT_TOPIC_ALERTS = "alerts";
        const CLIENT_ID = "Alarms_Dashboard_001";
        const MQTT_BROKER = "e2207633d3d84d30a58f34fb439d5580.s1.eu.hivemq.cloud";
        const MQTT_PORT = 8883;
        const MQTT_USER = "Maurrici";
        const MQTT_PASSWORD = "@123456mM";
        
        let client = null;
        let alarmsCount = 0;
        
        const statusEl = document.getElementById('connection-status');
        const alarmsListEl = document.getElementById('alarms-list');
        const connectButton = document.getElementById('connect-button');
        const configPanel = document.getElementById('config-panel');

        const ALERT_TYPES = {
            1: {
                name: "Aumento Repentino de Temperatura",
                color: "bg-red-500",
                icon: "üî•",
                message_template: (value) => `Aumento de M√©dia de ${value}¬∞C em 1 min. A√ß√£o Imediata Requerida!`
            },
            2: {
                name: "Temperatura M√©dia Alta",
                color: "bg-orange-500",
                icon: "‚ö†Ô∏è",
                message_template: (value) => `M√©dia atual de ${value}¬∞C excede o limite (200¬∞C).`
            }
        };

        function updateStatus(message, bgColor = 'bg-yellow-100', textColor = 'text-yellow-800') {
            statusEl.textContent = `Status: ${message}`;
            statusEl.className = `mt-4 p-2 text-sm font-medium rounded-full ${bgColor} ${textColor}`;
            
            const mainApp = document.getElementById('main-app');
            if (alarmsCount > 0) {
                mainApp.classList.add('alarm-pulse');
            } else {
                mainApp.classList.remove('alarm-pulse');
            }
        }

        function onConnect() {
            updateStatus("Conectado", 'bg-green-100', 'text-green-800');
            client.subscribe(MQTT_TOPIC_ALERTS, { qos: 1 });
            console.log("Subscrito ao t√≥pico: " + MQTT_TOPIC_ALERTS);

            //configPanel.style.display = 'none';
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                updateStatus(`Conex√£o perdida: ${responseObject.errorMessage}. Tentando reconectar...`, 'bg-red-100', 'text-red-800');
            }
        }

        function onMessageArrived(message) {
            try {
                const payload = JSON.parse(message.payloadString);
                displayAlarm(payload);
            } catch (e) {
                console.error("Erro ao processar mensagem MQTT:", e, message.payloadString);
            }
        }

        function connectMQTT() {
            /*const broker = document.getElementById('broker-input').value.trim();
            const user = document.getElementById('user-input').value.trim();
            const password = document.getElementById('password-input').value.trim();

            if (!broker || !user || !password) {
                updateStatus("Preencha todos os campos de conex√£o.", 'bg-red-100', 'text-red-800');
                return;
            }*/

            updateStatus("Conectando...");
            
            const port = 8884; 
            const path = "/mqtt";

            client = new Paho.MQTT.Client(MQTT_BROKER, port, path, CLIENT_ID);

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const options = {
                useSSL: true,
                timeout: 5,
                userName: MQTT_USER,
                password: MQTT_PASSWORD,
                onSuccess: onConnect,
                onFailure: (response) => {
                    updateStatus(`Falha na Conex√£o: ${response.errorMessage}`, 'bg-red-100', 'text-red-800');
                    console.error("Falha na Conex√£o MQTT:", response);
                }
            };
            
            try {
                client.connect(options);
            } catch (e) {
                console.error("Erro ao iniciar conex√£o:", e);
                updateStatus("Erro ao iniciar conex√£o. Verifique o broker.", 'bg-red-100', 'text-red-800');
            }
        }

        function displayAlarm(payload) {
            const type = ALERT_TYPES[payload.alert_type] || ALERT_TYPES.default;
            const timestamp = new Date(payload.timestamp * 1000);
            
            const message = payload.value !== undefined 
                ? type.message_template(payload.value) 
                : type.name;

            const listItem = document.createElement('li');
            listItem.className = `p-4 flex justify-between items-center rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01] ${type.color} text-white`;
            listItem.innerHTML = `
                <div class="flex items-center">
                    <span class="text-2xl mr-3">${type.icon}</span>
                    <div>
                        <p class="font-bold text-lg">${type.name}</p>
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-xs opacity-80">${timestamp.toLocaleTimeString()}</span>
                    <button onclick="dismissAlarm(this.parentNode.parentNode)" class="ml-4 text-xs font-semibold py-1 px-3 rounded-full bg-white bg-opacity-30 hover:bg-opacity-50 transition">
                        Dispensar
                    </button>
                </div>
            `;
            
            if (alarmsListEl.firstChild && alarmsListEl.firstChild.textContent.includes("Aguardando")) {
                alarmsListEl.removeChild(alarmsListEl.firstChild);
            }
            alarmsListEl.prepend(listItem);
            alarmsCount++;
            updateStatus("ALARMES ATIVOS", 'bg-red-100', 'text-red-800');
        }

        function dismissAlarm(listItem) {
            listItem.classList.add('opacity-0', 'h-0', 'p-0', 'm-0');
            listItem.addEventListener('transitionend', () => {
                listItem.remove();
                alarmsCount--;
                if (alarmsCount === 0) {
                    updateStatus("Conectado. Sem alarmes.", 'bg-green-100', 'text-green-800');
                    alarmsListEl.innerHTML = '<li class="p-3 bg-gray-50 border border-gray-200 text-gray-500 rounded-md">Nenhum alarme ativo.</li>';
                }
            });
        }

        /*document.addEventListener('DOMContentLoaded', () => {
            connectButton.addEventListener('click', connectMQTT);
            
            document.getElementById('broker-input').value = "SEU_BROKER_ID.s1.eu.hivemq.cloud";
            document.getElementById('user-input').value = "SEU_USUARIO";
            document.getElementById('password-input').value = "SUA_SENHA";
        });*/
        connectMQTT();
    </script>
</body>
</html>